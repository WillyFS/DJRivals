$(document).ready(function(){"use strict";var a={me:[],rival:[]},b=function(a,b){$(a).accordion({active:b,collapsible:true,heightStyle:"content"})},c=function(a,b){$(a).tabs({active:false,collapsible:true,event:"mouseover",heightStyle:"content",activate:b})},d=function(a){$(a).tablesorter({sortReset:true,sortRestart:true})},e=function(a,b){return $.map(a[(b.length===2?"pop_"+b:b).toLowerCase()],function(a,b){return[[b,a[0],a[1]]]})},f=function(b,c){var d=c.newTab.children().text(),e=$("#"+d).children(),f=e.first().text().replace(/\W/g,""),g;if(d.length===2){d="pop_"+d}g="./database/"+(f==="Master"?f+"/"+d:d+"/"+f)+".json";if(e.last().text()==="Loading..."){$.ajax({cache:false,dataType:"json",url:g.toLowerCase()}).done(function(b){var c=a.me.concat(a.rival),d=[],f=[],g=[],h=10,i,j,k;b=b.ranking;d=$.map(b,function(a){return a[2]});d=$.map(c,function(a,b){if($.inArray(a.name,d)<0){c.splice(b,1,false);return a.name}});c=$.map(c,function(a){if(a){return a.name}});f.push("<table><tr><th>Rank</th><th>Icon</th><th>DJ</th><th>Score</th></tr>");g.push("<table><tr><th>Rank</th><th>Icon</th><th>Rival DJ</th><th>Score</th></tr>");for(j=0,k=b.length;j<k;j+=1){if(c.length<1){if(h<1){break}h-=1}f.push("<tr><td>"+b[j][0]+'</td><td><img src="./images/icon/'+b[j][1]+'" /></td><td>'+b[j][2]+"</td><td>"+b[j][3]+"</td></tr>");i=$.inArray(b[j][2],c);if(i>-1){g.push("<tr><td>"+b[j][0]+'</td><td><img src="./images/icon/'+b[j][1]+'" /></td><td>'+b[j][2]+"</td><td>"+b[j][3]+"</td></tr>");c.splice(i,1)}}for(j=0,k=d.length;j<k;j+=1){g.push("<tr><td>-</td><td></td><td>"+d[j]+"</td><td>-</td></tr>")}e.last().empty().html('<table><tr><td class="djrank">'+f.join("")+'</table></td><td class="rivalrank">'+g.join("")+"</table></td></tr></table>")}).fail(function(){e.last().empty().html("Unable to retrieve data.")})}},g=function(a){if(a.length===0){$("#me").empty().html("<p>Go to settings to enter your DJ name.</p>")}else{$.ajax({cache:false,dataType:"json",url:"./database/dj/"+a[0].id+".json"}).done(function(a){var b=["Star","NM","HD","MX","Club","Mission"],f=[],g,h,i,j,k;f.push('<div id="me_tabs"><ul>');for(h=0,i=b.length;h<i;h+=1){f.push('<li><a href="#'+b[h]+'">'+b[h]+"</a></li>")}f.push("</ul>");for(h=0,i=b.length;h<i;h+=1){f.push('<div id="'+b[h]+'"><p><img src="./images/icon/'+a.icon+'" />'+a.name+"</p>");f.push('<table class="tablesorter"><thead><tr><th>Title</th><th>Rank</th><th>Score</th></tr></thead><tbody>');g=e(a,b[h]);for(j=0,k=g.length;j<k;j+=1){f.push("<tr><td>"+g[j][0]+"</td><td>"+g[j][1]+"</td><td>"+g[j][2]+"</td></tr>")}f.pop();f.push("</tbody></table></div>")}f.push("</div>");$("#me").empty().html(f.join(""));c("#me_tabs");d(".tablesorter")}).fail(function(){$("#me").empty().html("Unable to retrieve data.")})}},h=function(a,f){if(f.length===0){$("#rivals").empty().html("<p>Go to settings to enter your DJ rivals.</p>")}else{$.ajax({cache:false,dataType:"json",url:"./database/dj/"+a[0].id+".json"}).done(function(a){var g=["Star","NM","HD","MX","Club","Mission"],h=[],i,j,k;h.push('<div id="rivals_accordion">');for(j=0,k=f.length;j<k;j+=1){i=[0,0];h.push("<h3>"+f[j].name+"</h3>");h.push("<div>");$.ajax({async:false,cache:false,dataType:"json",url:"./database/dj/"+f[j].id+".json"}).done(function(b){var c,d,f,j,k,l,m,n;h.push('<div class="rival_tabs"><ul>');for(k=0,l=g.length;k<l;k+=1){h.push('<li><a href="#'+g[k]+'">'+g[k]+"</a></li>")}h.push("</ul>");for(k=0,l=g.length;k<l;k+=1){h.push('<div id="'+g[k]+'"><p><img src="./images/icon/'+a.icon+'" /> - vs - <img src="./images/icon/'+b.icon+'" /></p>');h.push('<table class="tablesorter"><thead><tr><th>Title</th><th>Me</th><th>Rival</th><th>Delta</th></tr></thead><tbody>');f=e(a,g[k]);j=e(b,g[k]);c=[0,0,0];for(m=0,n=f.length;m<n;m+=1){d=f[m][2]-j[m][2];if(f[m][2]>0&&j[m][2]>0){d>0?c[0]++:d<0?c[1]++:c[2]++}h.push("<tr><td>"+f[m][0]+"</td><td>"+f[m][2]+"</td><td>"+j[m][2]+"</td><td>"+d+"</td></tr>")}h.pop();h.push("</tbody></table><br />");h.push('<table id="stats"><thead><tr><th>Win</th><th>Lose</th><th>Draw</th></tr></thead><tbody>');h.push("<tr><td>"+c[0]+"</td><td>"+c[1]+"</td><td>"+c[2]+"</td></tr>");h.push("</tbody></table></div>");i[0]+=c[0];i[1]+=c[1]}h.push("</div>")}).fail(function(){h.push("Unable to retrieve data.")});h.push("</div>");h[$.inArray("<h3>"+f[j].name+"</h3>",h)]="<h3>"+f[j].name+"   "+i[0]+":"+i[1]+"</h3>"}h.push("</div>");$("#rivals").empty().html(h.join(""));b("#rivals_accordion",false);c(".rival_tabs");d(".tablesorter")}).fail(function(){$("#rivals").empty().html("Unable to retrieve data.")})}},i={f:function(a){return $.map(a.tokenInput("get"),function(a){return a.id})},g:function(a,b){return $.inArray(a,b)>-1?true:false},m:function(a){if(i.g(a.id,i.f($("#set_rival")))){$("#set_me").tokenInput("remove",{id:a.id})}},r:function(a){if(i.g(a.id,i.f($("#set_me")))){$("#set_rival").tokenInput("remove",{id:a.id})}}},j=function(){var b=function(a,b){var c=$.map(a,function(a){return a.id}).sort(),d=$.map(b,function(a){return a.id}).sort();return JSON.stringify(c)!==JSON.stringify(d)},c=$("#set_me").tokenInput("get"),d=$("#set_rival").tokenInput("get"),e=(new Date((new Date).setDate((new Date).getDate()+365))).toUTCString(),f="";if(b(c,a.me)||b(d,a.rival)){if(c.length>0||c.length===0&&d.length===0){a.me=c;a.rival=d;document.cookie="DJRivals_Settings="+JSON.stringify(a)+"; expires="+e;g(a.me);h(a.me,a.rival);f=":D"}else{f="Please enter your DJ name!"}}return f},k=function(){var b=document.cookie.split(/;\s*/),c,d;for(c=0,d=b.length;c<d;c+=1){if(b[c].indexOf("DJRivals_Settings")===0){b=JSON.parse(b[c].slice(b[c].indexOf("=")+1));a.me=b.me;a.rival=b.rival;break}}g(a.me);h(a.me,a.rival)},l=function(a){$("#set_status").empty();$("<span>"+a+"</span>").prependTo("#set_status").fadeOut(5e3,function(){$(this).remove()})};c("#ranking",f);b("#root");$.ajax({cache:false,dataType:"json",url:"./database/dj_index.json"}).done(function(b){$("#set_me").tokenInput(b,{hintText:"Type a DJ name",theme:"facebook",onAdd:i.m,prePopulate:a.me.length>0?a.me:null,tokenLimit:1});$("#set_rival").tokenInput(b,{hintText:"Type a DJ name",theme:"facebook",onAdd:i.r,prePopulate:a.rival.length>0?a.rival:null,preventDuplicates:true})}).fail(function(){$("#set_me").prop("disabled",true);$("#set_rival").prop("disabled",true);$("#set_apply").prop("disabled",true)});$("#set_apply").button().click(function(){l(j())});k()})